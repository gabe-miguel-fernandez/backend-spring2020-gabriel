<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />

    <title>ToDo App</title>
    <meta name="description" content="The To Do app page" />
    <meta name="author" content="Gabriel Fernandez" />

    <link rel="stylesheet" type="text/css" href="styles/reset.css">
    <link rel="stylesheet" type="text/css" href="styles/all.min.css">
    <link rel="stylesheet" type="text/css" href="styles/styles.css">

    <style>

      body {
        background-color: gold;
        font-family: Arial, Helvetica, sans-serif;
      }

      header {
        align-items: center;
        background-color: black;
        color: white;
        display: flex;
        flex-flow: row;
        justify-content: space-between;
        padding: 5px;
      }

      #header-title {
        font-size: x-large;
        flex-flow: row;
        padding: 0 0 0 15px;
      }

      #header-filter {
        display: flex;
        flex-direction: row;
        align-items: stretch;
      }

      #header-filter-label > h3 {
        text-align: right;
        font-size: medium;
        font-weight: 300;
        padding: 8px 8px 0 0;
      }

      #header-filter-buttons {
        padding: 15px 10px 5px 0;
      }

      #all, #not-done, #done {
        background-color: whitesmoke;
        border-radius: 3px;
        font-size: medium;
        font-weight: bold;
        width: 90px;
      }

      #message-box {
        background-color: #ffffe0;
        display: flex;
        flex-flow: column;
        border: 1px solid black;
        margin: 5px 2px 5px 2px;
      }

      #message-label {
        font-weight: bold;
        margin: 0 0 0 10px;
      }

      #message-list {
        height: 60px;
        overflow: auto;
        padding: 0 0 0 20px;
      }

      .btn-group-filter {
        border: 1px solid black;
        color: black;
        font-size: 24px;
        font-weight: bold;
        padding: 20px 0 0 0;
      }

      #newNote {
        background-color: white;
        border: 1px solid black;
        box-sizing: border-box;
        margin: 5px 0px 0px 0px;
        padding: 3px;
      }

      #newNoteText {
        border: 0px solid white;
        color: gray;
        font-size: x-large;
        width: 80%;
      }

      .note {
        display: flex;
        flex-direction: row;
        border: 3px solid black;
      }

      .note-buttons {
        align-items: center;
        background-color: #ffffe0;
        padding: 30px 0;
        text-align: center;
        width: 10%;
      }

      .taskBtn {
        font-weight: bold;
        width: 70px;
      }

      .note-data {
        display: flex;
        flex-direction: column;
        width: 100%;
      }

      .note-text {
        background-color: #ffff66;
        height: 80%;
        padding: 0px 0px 0px 20px;
      }

      .note-timestamp {
        background-color: #ffffe0;
        border: 5px;
        padding-left: 20px;
      }

      hr {
        color: black;
        height: 3px;
      }

      #modifyNote > #taskBtn {
        font-weight: bold;
        width: 100px;
      }

      #modifyNote > #updateNoteText {
        font-size: x-large;
        width: 90%;
      }

    </style>

    <!-- Use internet to get jQuery file to run in web page. -->
    <script
      src="https://code.jquery.com/jquery-3.5.0.min.js"
      integrity="sha256-xNzN2a4ltkB44Mc/Jz3pT4iU1cmeR0FkXs4pru/JxaQ="
      crossorigin="anonymous"
    ></script>
  </head>

  <body>
    <header>
      <div id="header-title">
        <h2>TO DO LIST</h1>
      </div>
      <div id="header-filter">
        <div id="header-filter-label">
          <h3>Filter by Status</h3>
        </div>
        <div class="btn-group-filter" id="header-filter-buttons">
            <input type="button" id="all" class="filterBtn" name="status" value="All">
            <input type="button" id="not-done" class="filterBtn" name="status" value="Not Done">
            <input type="button" id="done" class="filterBtn" name="status" value="Done">
        </div>  
      </div>
    </header>
    <section id="message-box">
      <div id="message-label">
        <p>Status Messages:</p>
      </div>
      <div id="message-list">
      </div>
    </section>
    <section id="new-note">
      <div id="newNote">
        <input type="submit" class="taskBtn" onclick="addTask(newNoteText.value)" value="New Note">
        <input type="text" id="newNoteText" value="Enter text for new task here.">
      </div>
      <hr>
    </section>
    <section id="note-list">
    </section>

    <script>
        function deleteTask(tstamp) {
          console.log(tstamp);
          let objectToDelete = {
            author: "Nick",
            create_date: tstamp
          };
          console.log(objectToDelete);
          $.post("http://localhost:3000/deleteNote", objectToDelete, (dataToGet) => {
            console.log(`Server says ${dataToGet}`);
          });
          const noteDate = new Date(tstamp);
          createdDate = noteDate.toLocaleDateString();
          // alert("delete - found item id = " + tstamp);
          
          $("#message-list").prepend(`<p>Deleted task that was created on ${createdDate}. Click one of the above filter buttons to see current To Do list.</p>`);
          $("#note-list").empty();
          showTasksByStatus("not-done");
        }

        function doneTask(tstamp) {
          console.log(tstamp);
          let objectToMarkComplete = {
            author: "Nick",
            create_date: tstamp
          };
          console.log(objectToMarkComplete);
          $.post("http://localhost:3000/markComplete", objectToMarkComplete, (dataToGet) => {
            console.log(`Server says ${dataToGet}`);
          });
          const noteDate = new Date(tstamp);
          createdDate = noteDate.toLocaleDateString();
          $("#note-list").empty();
          $("#message-list").prepend(`<p>Marked task that was created on ${createdDate} as completed. Click one of the above filter buttons to see current To Do list.</p>`);
          showTasksByStatus("done");
        }

        function editTask(tstamp) {
          // alert("edit - found item timestamp = " + tstamp);
          $("#new-note").hide();
          $("#note-list").empty();

          let formattedTask = 
          `<section id="modify-note">
            <div id="modifyNote">
              <input type="submit" class="taskBtn" tstamp="${tstamp}" onclick="updateTask(${tstamp}, updateNoteText.value)" value="Edit Note">
              <input type="text" id="updateNoteText" value="Enter new text for existing task here.">
            </div>
          </section>`;
          $("#note-list").append(formattedTask);
        }

        function updateTask(tstamp, modifiedNote) {
          // alert("id = " + tstamp + ", new text = " + modifiedNote);
          console.log(tstamp);
          console.log(modifiedNote);
          let ts = new Date(tstamp);
          let objectToUpdate = {
            author: "Nick",
            create_date: tstamp,
            updated_note: modifiedNote
          };
          console.log(objectToUpdate);
          // alert(objectToUpdate);
          $.post("http://localhost:3000/updateNote", objectToUpdate, (dataToGet) => {
            console.log(`Server says ${dataToGet.updatedStatus}`);
          });
          $("#message-list").prepend(`<p>Modified text for task that was created on ${ts.toLocaleDateString()}.</p>`);
          $("#new-note").show();
          $("#note-list").empty();
          showTasksByStatus("not-done");
        }

        function addTask(textTask) {
          // alert(`add task ${textTask}`);
          let objectToAdd = {
            author: "Nick",
            note: textTask
          };
          console.log(objectToAdd);
          $.post("http://localhost:3000/newNote", objectToAdd, (dataToGet) => {
            console.log(`Server says ${dataToGet}`);
          });
          $("#message-list").prepend(`<p>Added new task. Click one of the above filter buttons to see current To Do list.</p>`);
          let infoText = "Enter text for new task here.";
          $("#newNoteText").prop("value", `${infoText}`);
        }

        function showTasksByStatus(statusToView) {
          // alert("show task by status = " + statusToView);

          $.post("http://localhost:3000/readNotes", {}, (dataToGet) => {
            allNotesArray = dataToGet.notes;

            console.log("Requested notes data.");
            console.log("type of = " + typeof allNotesArray);
            console.log("count of array = " + allNotesArray.length);

            $("#note-list").empty();

            let taskCount = 0;

            for (let i = 0; i < allNotesArray.length; i++) {
              
              let ts = new Date(allNotesArray[i].create_date);
              let myNote = allNotesArray[i];
              let tstamp = allNotesArray[i].create_date;
              let user = allNotesArray[i].author;
              let deleteInfo = tstamp + "," + user;
              let noteStatus = (allNotesArray[i].completed_status ? "Done" : "Incomplete");
              let formattedTask = 
              `<div class="note" id="${tstamp}">
                <div class="note-buttons">
                  <button id="${tstamp}" author="${user}" class="taskBtn" name="doneBtn" value="Done" onClick="doneTask(${tstamp});">Done</button><br>
                  <button id="${tstamp}" author="${user}" class="taskBtn" name="doneBtn" value="Edit" onClick="editTask(${user});">Edit</button><br>
                  <button id="${tstamp}" author="${user}" class="taskBtn" name="doneBtn" value="Delete" onClick="deleteTask(${tstamp});">Delete</button>
                </div>
                <div class="note-data">
                  <div class="note-text">
                    <p>${allNotesArray[i].note}</p>
                  </div>
                  <div class="note-timestamp">
                    <p><b>Date Created: </b>${ts.toLocaleString()} (STATUS: ${noteStatus})</p>
                  </div>
                </div>
              </div>
              <hr>`;
              
              if (statusToView === "done") {
                if (noteStatus == "Done") {
                  $("#note-list").append(formattedTask);
                  taskCount++;
                }
              } else if (statusToView === "not-done") {
                if (noteStatus == "Incomplete") {
                  $("#note-list").append(formattedTask);
                  taskCount++;
                }
              } else {
                $("#note-list").append(formattedTask);
                taskCount++;
              }
            };

            let itemStatus;

            if (statusToView === "not-done") {
              itemStatus = "Incomplete";
            } else if (statusToView === "done") {
              itemStatus = "Completed";
            } else {
              itemStatus = "all";
            }
            $("#note-list").prepend(`<p>Found ${taskCount} ${itemStatus} task(s).</p>`);
          });
        }

      $(document).ready(() => {

        // let objectToSend = {
        //   // updated_note: "Do something completely new",
        //   author: "Nick",
        //   create_date: 1588990377480
        // };

        console.log("STATUS: document loaded.")

        let filterButtons = $(":button.filterBtn");
        console.log(filterButtons);

        filterButtons.click(() => {
          // alert("id = " + event.srcElement.id + ", class = " + event.srcElement.className);
          let statusToView = event.srcElement.id;
          // get any existing notes/tasks
          let allNotesArray;          

          $.post("http://localhost:3000/readNotes", {}, (dataToGet) => {
            allNotesArray = dataToGet.notes;

            console.log("Requested notes data.");
            console.log("type of = " + typeof allNotesArray);
            console.log("count of array = " + allNotesArray.length);

            $("#note-list").empty();

            let taskCount = 0;

            for (let i = 0; i < allNotesArray.length; i++) {
              
              let ts = new Date(allNotesArray[i].create_date);
              let myNote = allNotesArray[i];
              let tstamp = allNotesArray[i].create_date;
              let user = allNotesArray[i].author;
              let deleteInfo = tstamp + "," + user;
              let noteStatus = (allNotesArray[i].completed_status ? "Done" : "Incomplete");
              let formattedTask = 
              `<div class="note" id="${tstamp}">
                <div class="note-buttons">
                  <button id="${tstamp}" author="${user}" class="taskBtn" name="done" value="Done" onClick="doneTask(${tstamp});">Done</button><br>
                  <button id="${tstamp}" author="${user}" class="taskBtn" name="edit" value="Edit" onClick="editTask(${tstamp});">Edit</button><br>
                  <button id="${tstamp}" author="${user}" class="taskBtn" name="delete" value="Delete" onClick="deleteTask(${tstamp});">Delete</button>
                </div>
                <div class="note-data">
                  <div class="note-text">
                    <p>${allNotesArray[i].note}</p>
                  </div>
                  <div class="note-timestamp">
                    <p><b>Date Created: </b>${ts.toLocaleString()} (STATUS: ${noteStatus})</p>
                  </div>
                </div>
              </div>
              <hr>`;
              
              if (statusToView === "done") {
                if (noteStatus == "Done") {
                  $("#note-list").append(formattedTask);
                  taskCount++;
                }
              } else if (statusToView === "not-done") {
                if (noteStatus == "Incomplete") {
                  $("#note-list").append(formattedTask);
                  taskCount++;
                }
              } else {
                $("#note-list").append(formattedTask);
                taskCount++;
              }
              
            };
            $("#note-list").prepend(`<p>Found ${taskCount} task(s).</p>`);

          });
        });

        // deleteButtons.click(() => {
        //   alert(event.srcElement.id + ", " + event.srcElement.className + ", " + event.srcElement.name);
        // });

        // $.post("http://localhost:3000/markComplete", objectToSend, (dataToGet) => {
        //   console.log(`Server says ${dataToGet.markedComplete}`);
        // });

        // $.post("http://localhost:3000/newNote", objectToSend, (dataToGet) => {
        //   console.log(dataToGet);
        // });

        // $.post("http://localhost:3000/readNotes", {}, (dataToGet) => {
        //   let allNotesArray = dataToGet.notes;
        //   console.log(allNotesArray);
        // });

        // $.post("http://localhost:3000/updateNote", objectToSend, (dataToGet) => {
        //   console.log(`Server says ${dataToGet.updatedStatus}`);
        // });

      });
    </script>
  </body>
</html>
